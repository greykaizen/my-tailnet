---
# OpenSSH Setup for Windows Role
# Requirements: 2.5, 6.3

- name: Check if winget is available
  ansible.windows.win_shell: |
    if (Get-Command winget -ErrorAction SilentlyContinue) {
      Write-Output "available"
    } else {
      Write-Output "not_available"
    }
  register: winget_check
  changed_when: false

- name: Install OpenSSH Server via winget (latest version)
  ansible.windows.win_shell: |
    winget install --id Microsoft.OpenSSH.Beta --silent --accept-package-agreements --accept-source-agreements
  register: openssh_install
  changed_when: "'Successfully installed' in openssh_install.stdout or 'installed' in openssh_install.stdout"
  failed_when: openssh_install.rc != 0 and 'already installed' not in openssh_install.stdout.lower()
  when: winget_check.stdout | trim == 'available'

- name: Fallback to Windows Optional Feature if winget unavailable
  ansible.windows.win_optional_feature:
    name: OpenSSH.Server~~~~0.0.1.0
    state: present
  register: openssh_fallback
  when: winget_check.stdout | trim == 'not_available'

- name: Display OpenSSH installation method
  ansible.builtin.debug:
    msg: "OpenSSH installed via {{ 'winget (latest version)' if winget_check.stdout | trim == 'available' else 'Windows Optional Feature (bundled version)' }}"

- name: Ensure OpenSSH service is installed
  ansible.windows.win_service:
    name: sshd
    start_mode: auto
    state: started

- name: Create .ssh directory for ansible_admin
  ansible.windows.win_file:
    path: C:\Users\ansible_admin\.ssh
    state: directory

- name: Configure sshd_config with security settings
  ansible.windows.win_shell: |
    $configPath = "C:\ProgramData\ssh\sshd_config"
    $config = Get-Content $configPath -Raw
    
    # Security settings
    $config = $config -replace '(?m)^#?PasswordAuthentication.*$', 'PasswordAuthentication no'
    $config = $config -replace '(?m)^#?PubkeyAuthentication.*$', 'PubkeyAuthentication yes'
    $config = $config -replace '(?m)^#?PermitRootLogin.*$', 'PermitRootLogin no'
    $config = $config -replace '(?m)^#?AllowUsers.*$', 'AllowUsers ansible_admin @TeamShare @Administrators'
    $config = $config -replace '(?m)^#?Protocol.*$', 'Protocol 2'
    $config = $config -replace '(?m)^#?PermitEmptyPasswords.*$', 'PermitEmptyPasswords no'
    $config = $config -replace '(?m)^#?X11Forwarding.*$', 'X11Forwarding no'
    $config = $config -replace '(?m)^#?MaxAuthTries.*$', 'MaxAuthTries 3'
    $config = $config -replace '(?m)^#?ClientAliveInterval.*$', 'ClientAliveInterval 300'
    $config = $config -replace '(?m)^#?ClientAliveCountMax.*$', 'ClientAliveCountMax 2'
    $config = $config -replace '(?m)^#?Subsystem\s+sftp.*$', 'Subsystem sftp sftp-server.exe'
    
    Set-Content $configPath -Value $config
  register: sshd_config
  changed_when: true

- name: Configure Windows Firewall rule for SSH (port 22)
  community.windows.win_firewall_rule:
    name: OpenSSH Server (sshd)
    localport: 22
    action: allow
    direction: in
    protocol: tcp
    state: present
    enabled: yes
    profiles:
      - domain
      - private

- name: Restrict SSH firewall rule to Tailscale network only
  community.windows.win_firewall_rule:
    name: OpenSSH Server (sshd) - Tailscale Only
    localport: 22
    action: allow
    direction: in
    protocol: tcp
    remoteip: 100.64.0.0/10
    state: present
    enabled: yes
    profiles:
      - domain
      - private
      - public

- name: Ensure sshd service is running
  ansible.windows.win_service:
    name: sshd
    state: started
    start_mode: auto

- name: Configure sshd service failure recovery
  ansible.windows.win_shell: |
    sc.exe failure sshd reset= 86400 actions= restart/60000/restart/60000/restart/60000
  args:
    executable: cmd
